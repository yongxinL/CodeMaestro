#!/usr/bin/env node

const { program } = require('commander');
const chalk = require('chalk');
const fs = require('fs-extra');
const path = require('path');

const config = require('../lib/config');
const logger = require('../lib/logger');
const projectDetector = require('../lib/project');

/**
 * Get task for a specific phase
 */
function getPhaseTask(phaseNumber) {
  const phaseTasks = {
    1: {
      name: 'Requirements',
      role: 'Product Manager',
      firstTask: 'Analyze project requirements and create specification document',
      description: 'Product Manager - Define specifications'
    },
    2: {
      name: 'Planning',
      role: 'Software Architect',
      firstTask: 'Design system architecture and component structure',
      description: 'Software Architect - Design architecture'
    },
    3: {
      name: 'Implementation',
      role: 'Senior Developer',
      firstTask: 'Implement core functionality and business logic',
      description: 'Senior Developer - Build code'
    },
    4: {
      name: 'Verification',
      role: 'QA Lead',
      firstTask: 'Collect evidence package and test results',
      description: 'QA Lead - Test and validate'
    },
    5: {
      name: 'Release',
      role: 'Release Manager',
      firstTask: 'Coordinate final release preparation',
      description: 'Release Manager - Deploy and release'
    }
  };

  return phaseTasks[phaseNumber];
}

/**
 * Validate phase number
 */
function validatePhaseNumber(phaseNumber) {
  const num = parseInt(phaseNumber);

  if (isNaN(num)) {
    throw new Error(`Invalid phase number: ${phaseNumber}. Must be a number between 1-5.`);
  }

  if (num < 1 || num > 5) {
    throw new Error(`Phase number must be between 1 and 5. Got: ${num}`);
  }

  return num;
}

/**
 * Update checkpoint to specific phase
 */
async function updatePhaseCheckpoint(phaseNumber) {
  const projectConfig = await config.load();
  const checkpointPath = projectConfig.paths.recovery_checkpoint;

  // Ensure implementation directory exists
  await fs.ensureDir(path.dirname(checkpointPath));

  const phaseInfo = getPhaseTask(phaseNumber);
  const timestamp = new Date().toISOString();

  const checkpoint = `# CodeMaestro Recovery Checkpoint

**Last Updated:** ${timestamp}
**Phase:** ${phaseNumber}
**Role:** ${phaseInfo.role}
**Current Task:** ${phaseInfo.firstTask}

## Phase Progress

- üéØ Jumped to Phase ${phaseNumber}: ${phaseInfo.name}

## Recovery Information

If this session is interrupted, use the following commands to resume:

1. **Current Phase:** \`${phaseNumber}\`
2. **Current Role:** ${phaseInfo.role}
3. **Resume Command:** \`/codem-next\`

## Task Guidance

**Next Steps:**
- Focus on: ${phaseInfo.firstTask}
- Role: ${phaseInfo.role}
- Use available tools and documentation to complete this task

---
*Auto-generated by CodeMaestro OpenCode*
`;

  await fs.writeFile(checkpointPath, checkpoint);
  return checkpointPath;
}

/**
 * Display phase information
 */
function displayPhaseInfo(phaseNumber, checkpointPath) {
  const phaseInfo = getPhaseTask(phaseNumber);

  console.log(chalk.bold.blue('üéØ CodeMaestro Phase Navigation'));
  console.log('‚ïê'.repeat(50));

  console.log(chalk.bold(`üìä Phase ${phaseNumber}:`), chalk.cyan(phaseInfo.name));
  console.log(`   ${phaseInfo.description}`);

  console.log(chalk.bold('\nüë§ Role:'), chalk.green(phaseInfo.role));
  console.log(chalk.bold('üéØ Starting Task:'), phaseInfo.firstTask);

  console.log('\n' + chalk.green('üéØ Phase navigation successful!'));

  // Phase-specific guidance
  console.log('\n' + chalk.bold('üí° Phase Guidance:'));

  switch (phaseNumber) {
  case 1:
    console.log('‚Ä¢ Define project requirements and objectives');
    console.log('‚Ä¢ Create detailed specifications document');
    console.log('‚Ä¢ Analyze competitive landscape');
    console.log('‚Ä¢ Identify success criteria');
    break;
  case 2:
    console.log('‚Ä¢ Design system architecture and components');
    console.log('‚Ä¢ Create technical blueprints');
    console.log('‚Ä¢ Plan development tasks and dependencies');
    console.log('‚Ä¢ Estimate effort and resources');
    break;
  case 3:
    console.log('‚Ä¢ Implement core functionality');
    console.log('‚Ä¢ Follow established architectural patterns');
    console.log('‚Ä¢ Write comprehensive tests');
    console.log('‚Ä¢ Track progress and quality');
    break;
  case 4:
    console.log('‚Ä¢ Collect evidence and test results');
    console.log('‚Ä¢ Perform security and performance testing');
    console.log('‚Ä¢ Validate against requirements');
    console.log('‚Ä¢ Prepare for release decision');
    break;
  case 5:
    console.log('‚Ä¢ Finalize release preparations');
    console.log('‚Ä¢ Document lessons learned');
    console.log('‚Ä¢ Execute deployment process');
    console.log('‚Ä¢ Monitor initial performance');
    break;
  }

  console.log('\n' + chalk.bold('üîß Available Commands:'));
  console.log(`‚Ä¢ ${chalk.cyan('/codem-next')} - Continue to next task`);
  console.log(`‚Ä¢ ${chalk.cyan('/codem-status')} - Check current progress`);
  console.log(`‚Ä¢ ${chalk.cyan('/codem-commit')} - Create progress commits`);
  console.log(`‚Ä¢ ${chalk.cyan('/codem-kb')} - Manage knowledge base`);

  if (phaseNumber >= 2) {
    console.log(`‚Ä¢ ${chalk.cyan('/codem-research')} - Research and analysis tools`);
    console.log(`‚Ä¢ ${chalk.cyan('/codem-lookup')} - Technical documentation lookup`);
  }

  console.log('\n' + chalk.gray(`Checkpoint saved: ${path.relative(process.cwd(), checkpointPath)}`));
  console.log('‚ïê'.repeat(50));
}

/**
 * Navigate to specific phase
 */
async function phaseCommand(phaseNumber) {
  try {
    logger.info(`Navigating to CodeMaestro Phase ${phaseNumber}...`);

    // Check if this is a CodeMaestro project
    if (!await projectDetector.isCodeMaestroProject()) {
      logger.error('Not a CodeMaestro project. Run `/codem-init` first.');
      console.log(chalk.blue(`
üí° To initialize a CodeMaestro project:
   ${chalk.cyan('/codem-init')}
      `));
      return;
    }

    // Validate phase number
    const validatedPhase = validatePhaseNumber(phaseNumber);

    // Get current phase for context
    const currentPhaseInfo = await projectDetector.getCurrentPhase();
    const currentPhase = currentPhaseInfo?.phase;

    if (currentPhase && currentPhase === validatedPhase) {
      console.log(chalk.yellow(`‚ö†Ô∏è  Already in Phase ${validatedPhase}. Use \`/codem-next\` to continue.`));
      return;
    }

    // Update checkpoint to new phase
    const checkpointPath = await updatePhaseCheckpoint(validatedPhase);

    // Display information
    displayPhaseInfo(validatedPhase, checkpointPath);

    // Success message
    const action = currentPhase ? 'switched' : 'started';
    console.log(chalk.green(`\n‚úÖ Successfully ${action} to Phase ${validatedPhase}: ${getPhaseTask(validatedPhase).name}`));

  } catch (error) {
    logger.error('Failed to navigate to phase', error);
    console.log(chalk.red(`\n‚ùå Error: ${error.message}`));
    console.log(chalk.gray('\nValid phases: 1-5'));
    console.log(chalk.gray('Usage: /codem-phase [1-5]'));
    process.exit(1);
  }
}

// CLI setup
program
  .name('codem-phase')
  .description('Navigate to a specific CodeMaestro phase (1-5)')
  .argument('<phase>', 'Phase number (1-5)')
  .action(phaseCommand);

// Export for testing
module.exports = {
  getPhaseTask,
  validatePhaseNumber,
  updatePhaseCheckpoint,
  displayPhaseInfo,
  phaseCommand
};

// Only parse if this file is run directly
if (require.main === module) {
  program.parse();
}